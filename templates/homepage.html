<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gamification Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Header -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center shadow">
    <h1 class="text-xl font-bold">Gamification Platform</h1>
    <div id="user-status" class="text-sm">Not logged in</div>
  </header>

  <div class="flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg min-h-screen p-4 space-y-4">
      <button onclick="showSection('login-section')" class="w-full bg-blue-500 text-white py-2 rounded">🔑 Login</button>
      <button onclick="showSection('register-section')" class="w-full bg-green-500 text-white py-2 rounded">📝 Register</button>
      <hr>
      <button onclick="showSection('games-section')" class="w-full bg-gray-200 py-2 rounded">🎮 Competitions</button>
      <button onclick="showSection('achievements-section')" class="w-full bg-gray-200 py-2 rounded">🏆 Achievements</button>
      <button onclick="showSection('leaderboards-section')" class="w-full bg-gray-200 py-2 rounded">📊 Leaderboards</button>
      <button onclick="showSection('rewards-section')" class="w-full bg-gray-200 py-2 rounded">🎁 Rewards</button>
      <button onclick="showSection('social-section')" class="w-full bg-gray-200 py-2 rounded">👥 Social</button>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-6">

      <!-- Login -->
      <section id="login-section" class="hidden">
        <h2 class="text-2xl mb-4">Login</h2>
        <input id="login-username" class="border p-2 w-full mb-2" placeholder="Username">
        <input id="login-password" type="password" class="border p-2 w-full mb-2" placeholder="Password">
        <button onclick="loginUser()" class="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
      </section>

      <!-- Register -->
      <section id="register-section" class="hidden">
        <h2 class="text-2xl mb-4">Register</h2>
        <input id="reg-username" class="border p-2 w-full mb-2" placeholder="Username">
        <input id="reg-password" type="password" class="border p-2 w-full mb-2" placeholder="Password">
        <button onclick="registerUser()" class="bg-green-600 text-white px-4 py-2 rounded">Register</button>
      </section>

      <!-- Competitions -->
      <section id="games-section" class="hidden">
        <h2 class="text-2xl mb-4">Competitions</h2>
        <div class="space-x-2">
          <button onclick="sendRequest('games_create')" class="bg-blue-500 text-white px-3 py-2 rounded">Create</button>
          <button onclick="sendRequest('games_active')" class="bg-gray-500 text-white px-3 py-2 rounded">Active</button>
          <button onclick="sendRequest('games_join')" class="bg-green-500 text-white px-3 py-2 rounded">Join</button>
          <button onclick="sendRequest('games_progress_update')" class="bg-yellow-500 text-white px-3 py-2 rounded">Update Progress</button>
          <button onclick="sendRequest('games_custom_create')" class="bg-purple-500 text-white px-3 py-2 rounded">Custom Rules</button>
        </div>
        <pre id="games-output" class="bg-white p-3 mt-3 rounded shadow"></pre>
      </section>

      <!-- Achievements -->
      <section id="achievements-section" class="hidden">
        <h2 class="text-2xl mb-4">Achievements</h2>
        <div class="space-x-2">
          <button onclick="sendRequest('achievements_available')" class="bg-blue-500 text-white px-3 py-2 rounded">Available</button>
          <button onclick="sendRequest('achievements_unlock')" class="bg-green-500 text-white px-3 py-2 rounded">Unlock</button>
          <button onclick="sendRequest('achievements_my_progress')" class="bg-yellow-500 text-white px-3 py-2 rounded">My Progress</button>
          <button onclick="sendRequest('achievements_create_custom')" class="bg-purple-500 text-white px-3 py-2 rounded">Custom</button>
          <button onclick="sendRequest('achievements_rare')" class="bg-pink-500 text-white px-3 py-2 rounded">Rare</button>
          <button onclick="sendRequest('achievements_share')" class="bg-indigo-500 text-white px-3 py-2 rounded">Share</button>
        </div>
        <pre id="achievements-output" class="bg-white p-3 mt-3 rounded shadow"></pre>
        <canvas id="achievementsChart" class="mt-4"></canvas>
      </section>

      <!-- Leaderboards -->
      <section id="leaderboards-section" class="hidden">
        <h2 class="text-2xl mb-4">Leaderboards</h2>
        <div class="space-x-2">
          <button onclick="sendRequest('leaderboards_global')" class="bg-blue-500 text-white px-3 py-2 rounded">Global</button>
          <button onclick="sendRequest('leaderboards_team')" class="bg-green-500 text-white px-3 py-2 rounded">Team</button>
          <button onclick="sendRequest('leaderboards_monthly')" class="bg-yellow-500 text-white px-3 py-2 rounded">Monthly</button>
          <button onclick="sendRequest('leaderboards_hall_of_fame')" class="bg-purple-500 text-white px-3 py-2 rounded">Hall of Fame</button>
          <button onclick="sendRequest('leaderboards_predictions')" class="bg-pink-500 text-white px-3 py-2 rounded">Predictions</button>
        </div>
        <pre id="leaderboards-output" class="bg-white p-3 mt-3 rounded shadow"></pre>
      </section>

      <!-- Rewards -->
      <section id="rewards-section" class="hidden">
        <h2 class="text-2xl mb-4">Rewards</h2>
        <div class="space-x-2">
          <button onclick="sendRequest('rewards_teams_create')" class="bg-blue-500 text-white px-3 py-2 rounded">Teams Create</button>
          <button onclick="sendRequest('rewards_friends')" class="bg-green-500 text-white px-3 py-2 rounded">Friends</button>
          <button onclick="sendRequest('rewards_challenges_send')" class="bg-yellow-500 text-white px-3 py-2 rounded">Challenges</button>
          <button onclick="sendRequest('rewards_activity_feed')" class="bg-purple-500 text-white px-3 py-2 rounded">Activity Feed</button>
          <button onclick="sendRequest('rewards_rivalries')" class="bg-pink-500 text-white px-3 py-2 rounded">Rivalries</button>
        </div>
        <pre id="rewards-output" class="bg-white p-3 mt-3 rounded shadow"></pre>
      </section>

      <!-- Social -->
      <section id="social-section" class="hidden">
        <h2 class="text-2xl mb-4">Social</h2>
        <div class="space-x-2">
          <button onclick="sendRequest('social_available')" class="bg-blue-500 text-white px-3 py-2 rounded">Available</button>
          <button onclick="sendRequest('social_redeem')" class="bg-green-500 text-white px-3 py-2 rounded">Redeem</button>
          <button onclick="sendRequest('social_my_points')" class="bg-yellow-500 text-white px-3 py-2 rounded">My Points</button>
          <button onclick="sendRequest('social_donate_points')" class="bg-purple-500 text-white px-3 py-2 rounded">Donate Points</button>
          <button onclick="sendRequest('social_store')" class="bg-pink-500 text-white px-3 py-2 rounded">Store</button>
          <button onclick="sendRequest('social_suggest')" class="bg-indigo-500 text-white px-3 py-2 rounded">Suggest</button>
        </div>
        <pre id="social-output" class="bg-white p-3 mt-3 rounded shadow"></pre>
      </section>
    </main>
  </div>

<script>
let authToken = null;
let presets = {};

// Section switcher
function showSection(id) {
  document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

// JSON → table
function jsonToTable(json) {
  if (!json) return "<p>No data</p>";
  if (typeof json === "string") return `<p>${json}</p>`;
  if (!Array.isArray(json)) json = [json];

  const headers = [...new Set(json.flatMap(obj => Object.keys(obj)))];
  let table = `<table class="table-auto border-collapse border border-gray-300 w-full text-sm">
    <thead class="bg-gray-100">
      <tr>${headers.map(h => `<th class="border px-2 py-1">${h}</th>`).join("")}</tr>
    </thead>
    <tbody>
      ${json.map(row => `
        <tr>
          ${headers.map(h => `<td class="border px-2 py-1">${row[h] ?? ""}</td>`).join("")}
        </tr>`).join("")}
    </tbody>
  </table>`;
  return table;
}

// Register user
async function registerUser() {
  const username = document.getElementById("reg-username").value;
  const password = document.getElementById("reg-password").value;
  const res = await fetch("http://127.0.0.1:5001/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  alert("Registered: " + JSON.stringify(data));
}

// Login user
async function loginUser() {
  const username = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;
  const res = await fetch("http://127.0.0.1:5001/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  if (res.ok) {
    authToken = data.token || "session";
    document.getElementById("user-status").innerText = "Logged in as " + username;
    alert("Login successful!");
  } else {
    alert("Login failed: " + JSON.stringify(data));
  }
}

// Load presets
fetch("/static/presets.txt")
  .then(res => res.text())
  .then(txt => { presets = JSON.parse(txt); })
  .catch(err => console.error("Failed to load presets", err));

// Send API request
// Open editor panel
function sendRequest(name) {
  if (!presets[name]) return alert("Preset not found: " + name);
  currentPreset = presets[name];
  currentPreset.name = name;
  currentTarget = document.querySelector(`#${name.split("_")[0]}-output`);

  if (["POST", "PUT", "PATCH", "DELETE"].includes(currentPreset.method.toUpperCase())) {
    document.getElementById("request-title").innerText = `${currentPreset.method} ${name}`;
    
    // Build form fields from JSON body
    let fieldsContainer = document.getElementById("request-fields");
    fieldsContainer.innerHTML = "";
    let bodyObj = {};
    try { bodyObj = currentPreset.body ? JSON.parse(currentPreset.body) : {}; }
    catch { bodyObj = {}; }

    Object.entries(bodyObj).forEach(([key, value]) => {
      let field = document.createElement("div");
      field.className = "flex items-center gap-2";
      field.innerHTML = `
        <label class="w-1/3 font-semibold">${key}</label>
        <input type="text" data-key="${key}" value="${value}" 
          class="flex-1 border rounded px-2 py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none"/>
      `;
      fieldsContainer.appendChild(field);
    });

    document.getElementById("request-panel").classList.remove("hidden");
  } else {
    confirmRequest(); // auto send if no body is needed
  }
}


// Close modal
function closePanel() {
  document.getElementById("request-panel").classList.add("hidden");
  currentPreset = null;
  currentTarget = null;
}

// Confirm and send
async function confirmRequest() {
  if (!currentPreset) return;

  let options = { method: currentPreset.method };

  if (["POST","PUT","PATCH","DELETE"].includes(currentPreset.method.toUpperCase())) {
    options.headers = { "Content-Type": "application/json" };

    let newBody = {};
    document.querySelectorAll("#request-fields input").forEach(input => {
      newBody[input.dataset.key] = input.value;
    });

    options.body = JSON.stringify(newBody);
  }

  try {
    const res = await fetch(currentPreset.url, options);
    const txt = await res.text();
    let data; try { data = JSON.parse(txt); } catch { data = txt; }

    if (currentTarget) {
      currentTarget.innerHTML = (typeof data === "object") ? jsonToTable(data) : `<pre>${txt}</pre>`;
    }
  } catch (err) {
    alert("Error: " + err);
  } finally {
    closePanel();
  }
}

</script>
<!-- Request Editor Panel -->
<div id="request-panel" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="w-11/12 max-w-2xl p-6 border rounded-lg shadow bg-white">
    <h2 id="request-title" class="text-lg font-bold mb-2">Request Editor</h2>
    <p class="text-sm text-gray-600 mb-2">Edit the request body before sending:</p>

    <div id="request-fields" class="space-y-2"></div>

    <div class="flex justify-end gap-2 mt-3">
      <button onclick="closePanel()" 
        class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button>
      <button onclick="confirmRequest()" 
        class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Send Request</button>
    </div>
  </div>
</div>


</body>
</html>
